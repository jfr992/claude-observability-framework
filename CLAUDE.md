# Claude Code Metrics

Local observability stack for tracking Claude Code usage, cost, and ROI via OpenTelemetry.

## Quick Start

```bash
# Start (use podman or docker)
podman compose up -d

# Access
open http://localhost:3000  # Grafana (admin / claudecode)
open http://localhost:9090  # Prometheus
```

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│   Claude Code   │────▶│  OTEL Collector  │────▶│  Prometheus │
│  (your terminal)│     │   :4317/:4318    │     │    :9090    │
└─────────────────┘     └──────────────────┘     └──────┬──────┘
                                                        │
                                                        ▼
                                                 ┌─────────────┐
                                                 │   Grafana   │
                                                 │    :3000    │
                                                 └─────────────┘
```

## File Structure

```
claude-metrics/
├── docker-compose.yaml          # Container orchestration
├── otel-config.yaml             # OTEL Collector pipeline
├── prometheus.yaml              # Prometheus scrape config
├── grafana/
│   ├── dashboards/
│   │   └── claude-code.json     # Main dashboard
│   └── provisioning/            # Auto-provisioning
├── scripts/
│   └── generate-roi-report.sh   # CLI report generator
├── data/                        # Persistent storage (git-ignored)
│   ├── prometheus/              # TSDB (30-day retention)
│   └── grafana/                 # Grafana DB
└── CLAUDE.md                    # This file
```

## Enabling Telemetry

Set these environment variables before running Claude Code:

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

## Available Metrics

Claude Code exports these metrics automatically:

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `claude_code_cost_usage_USD_total` | Counter | model, session_id, user_email | Cumulative cost in USD |
| `claude_code_token_usage_tokens_total` | Counter | model, type | Token counts |
| `claude_code_session_count_total` | Counter | - | Session starts |
| `claude_code_active_time_seconds_total` | Counter | - | Active usage time |
| `claude_code_lines_of_code_count_total` | Counter | type (added/removed) | Lines changed |
| `claude_code_code_edit_tool_decision_total` | Counter | decision, tool, language | Edit accepts/rejects |
| `claude_code_pull_request_count_total` | Counter | - | PRs created |
| `claude_code_commit_count_total` | Counter | - | Commits created |

### Token Types

The `type` label on `token_usage` has these values:
- `input` - Tokens sent to the model
- `output` - Tokens generated by the model
- `cacheRead` - Tokens read from prompt cache
- `cacheCreation` - Tokens used to create cache

### Built-in Labels

These labels are automatically added by Claude Code:

| Label | Example | Description |
|-------|---------|-------------|
| `model` | `claude-sonnet-4-20250514` | Model identifier |
| `session_id` | `a549970d-91dc-...` | Unique session ID |
| `user_email` | `user@example.com` | User's email |
| `user_account_uuid` | `279cebac-...` | User's account ID |
| `organization_id` | `99bd0c58-...` | Organization ID |
| `terminal_type` | `iTerm.app`, `vscode` | Terminal/IDE |
| `service_version` | `2.1.27` | Claude Code version |

## Dashboard Sections

### 1. Overview Row
- **Total Cost** - Sum of all costs in time range
- **Tokens** - Total token usage
- **Sessions** - Unique session count
- **Active Time** - Time spent in Claude Code
- **Lines +/-** - Code added/removed
- **Input/Output** - Token breakdown

### 2. ROI Metrics Row
- **PRs Created** - Pull requests made via Claude
- **Commits** - Git commits made via Claude
- **Cost/PR** - Average cost per pull request
- **Edits** - Total edit tool invocations
- **Accept %** - Edit acceptance rate (higher = better suggestions)
- **Cache Ratio** - Cache reads / cache creation (higher = better efficiency)

### 3. Breakdown Row
- Cost by Model (time series)
- Tokens by Type (time series)
- Cost by User (pie)
- Tokens by Type (pie)
- Cost by Model (pie)
- By Terminal (pie)

### 4. Bedrock Breakdown Row (Collapsed)
Requires custom `OTEL_RESOURCE_ATTRIBUTES` setup:
- Inference Profile vs Direct model
- By AWS Profile
- Bedrock Summary

### 5. Session Details
Table showing each session with:
- Session ID
- Provider
- Model
- Cost
- Tokens

### 6. Model Breakdown
- Cost by Model (time series)
- Tokens by Model (time series)
- Model Details table (cost, input, output, cache read)

## ROI Measurement

### Generate Report

```bash
# Last 7 days (default)
./scripts/generate-roi-report.sh

# Last 30 days
RANGE=30d ./scripts/generate-roi-report.sh

# Save to file
./scripts/generate-roi-report.sh > report.md
```

### Key ROI Metrics

| Metric | Formula | Good Value |
|--------|---------|------------|
| **Cost per PR** | total_cost / pr_count | < $5 |
| **Accept Rate** | accepts / (accepts + rejects) | > 80% |
| **Cache Ratio** | cache_reads / cache_created | > 20:1 |
| **Cost per Hour** | total_cost / active_hours | < hourly rate |

### ROI Calculation

```
ROI = (Value Created - Cost) / Cost

Value Created =
  (PRs × avg_PR_value) +
  (Hours_saved × hourly_rate) +
  (Bugs_prevented × bug_cost)
```

### Subscription vs API Comparison

| Plan | Monthly | Break-even API Cost |
|------|---------|---------------------|
| Claude Pro | $20 | $20/month |
| Claude Max 5x | $100 | $100/month |
| Claude Max 20x | $200 | $200/month |
| API (Bedrock/Direct) | Variable | N/A |

Use the dashboard to track if your API costs exceed subscription thresholds.

## Custom Labels (Optional)

To track provider/Bedrock details, set `OTEL_RESOURCE_ATTRIBUTES`:

```bash
# For Bedrock with inference profile
export OTEL_RESOURCE_ATTRIBUTES="provider=bedrock,inference_type=inference-profile,aws_profile=my-profile"

# For Anthropic Max
export OTEL_RESOURCE_ATTRIBUTES="provider=anthropic-max"
```

These enable the Bedrock Breakdown section in the dashboard.

## Common Tasks

### Check if metrics are flowing
```bash
podman logs claude-otel-collector 2>&1 | grep MetricsExporter
```

### Query Prometheus directly
```bash
# List all claude metrics
curl -s 'http://localhost:9090/api/v1/label/__name__/values' | jq -r '.data[]' | grep claude

# Get current cost
curl -s 'http://localhost:9090/api/v1/query?query=sum(claude_code_cost_usage_USD_total)' | jq '.data.result[0].value[1]'

# Get token breakdown
curl -s 'http://localhost:9090/api/v1/query?query=sum by (type) (claude_code_token_usage_tokens_total)' | jq '.data.result'
```

### Restart services
```bash
podman compose restart grafana           # After dashboard edits
podman compose restart otel-collector    # After OTEL config changes
podman compose down && podman compose up -d  # Full restart
```

### Backup data
```bash
# Data persists in ./data/ - just copy the directory
cp -r data/ backup/
```

## Troubleshooting

### No data in Grafana
1. Check OTEL collector is receiving data:
   ```bash
   podman logs claude-otel-collector | grep MetricsExporter
   ```
2. Verify telemetry is enabled:
   ```bash
   echo $CLAUDE_CODE_ENABLE_TELEMETRY  # Should be 1
   ```
3. Check Prometheus targets:
   Open http://localhost:9090/targets

### Metrics show 0 or stale
- Prometheus marks metrics as stale after 5 minutes of no updates
- Dashboard uses `max_over_time()` for infrequently-updated counters
- Check time range selector in Grafana (top right)

### Dashboard looks wrong
```bash
podman compose restart grafana
```

### Container won't start
```bash
podman machine start  # If using podman
podman compose down
podman compose up -d
```

## Data Retention

- **Prometheus**: 30 days (configured in docker-compose.yaml)
- **Grafana**: Indefinite (dashboards, users, settings)
- **Location**: `./data/` directory (persists across container restarts)

## References

- [Claude Code Monitoring Docs](https://docs.anthropic.com/en/docs/claude-code/monitoring)
- [Anthropic ROI Guide](https://github.com/anthropics/claude-code-monitoring-guide)
- [OpenTelemetry Spec](https://opentelemetry.io/docs/specs/otel/)
