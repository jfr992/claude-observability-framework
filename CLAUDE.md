# Claude Observability Framework

Framework for improving human-AI collaboration via OpenTelemetry metrics.

**Philosophy:** You are the Architect. Claude is your implementation partner. We measure communication quality, not productivity. See [GUIDE.md](GUIDE.md) for the full philosophy.

## Quick Start

```bash
# Start (use podman or docker)
podman compose up -d

# Access
open http://localhost:3000  # Grafana (admin / claudecode)
open http://localhost:9090  # Prometheus
```

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐     ┌─────────────┐
│   Claude Code   │────▶│  OTEL Collector  │────▶│  Prometheus │────▶│   Grafana   │
│  (your terminal)│     │   :4317/:4318    │     │    :9090    │     │    :3000    │
└─────────────────┘     └────────┬─────────┘     └─────────────┘     └─────────────┘
                                 │
                                 ▼
                          ┌─────────────┐
                          │    Loki     │  (logs for tool usage)
                          │    :3100    │
                          └─────────────┘
```

## File Structure

```
claude-metrics/
├── docker-compose.yaml          # Container orchestration
├── otel-config.yaml             # OTEL Collector pipeline (metrics + logs)
├── prometheus.yaml              # Prometheus scrape config
├── loki-config.yaml             # Loki log storage config
├── grafana/
│   ├── dashboards/
│   │   ├── claude-code.json     # Personal dashboard
│   │   └── team-overview.json   # Team dashboard
│   └── provisioning/            # Auto-provisioning
├── scripts/
│   ├── setup-mac.sh             # Mac onboarding (interactive)
│   ├── generate-report.sh       # Communication quality report (3 key metrics)
│   ├── check-storage.sh         # Storage usage monitor
│   └── health-check.sh          # Stack health + key metrics check
├── prompts/                      # Reusable prompt templates
│   ├── code-review.md           # Constructive code review
│   ├── security-review.md       # Security vulnerability analysis
│   ├── write-tests.md           # Test generation with coverage
│   └── debug.md                 # Systematic debugging
├── .claude/skills/
│   └── prompt-builder.md        # /prompt skill for creating templates
├── TESTING.md                   # Testing guide and patterns
├── data/                        # Persistent storage (git-ignored)
│   ├── prometheus/              # Metrics TSDB
│   ├── loki/                    # Log storage
│   └── grafana/                 # Grafana DB
├── CLAUDE.md                    # This file
├── GUIDE.md                     # Co-intelligence philosophy & optimization guide
└── README.md                    # Project overview
```

## Enabling Telemetry

Set these environment variables before running Claude Code:

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_LOGS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

Or use the interactive setup:
```bash
./scripts/setup-mac.sh
```

Or use [claude-switch](https://github.com/your-org/claude-switcher) which configures telemetry automatically.

## Dashboards

### Personal Dashboard (claude-code)
- **Overview:** Cost, tokens, sessions, lines of code
- **Efficiency:** Accept Rate, Cache Ratio, Session Size gauges
- **Breakdown:** By model, by token type, by terminal
- **Tool Usage:** From Loki logs - see which tools you use most

### Team Dashboard (team-overview)
- **Organization Overview:** Total cost, active users, PRs, commits
- **ROI Metrics:** Cost/PR, Cost/Session, Cost/Commit, Sessions/PR
- **Developer Leaderboard:** Per-user metrics table
- **Tool Usage:** Team-wide tool distribution
- **Productivity:** Lines added/removed, active time, cost/hour

## Available Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `claude_code_cost_usage_USD_total` | Counter | Cumulative cost in USD |
| `claude_code_token_usage_tokens_total` | Counter | Token counts by type |
| `claude_code_session_count_total` | Counter | Session starts |
| `claude_code_active_time_seconds_total` | Counter | Active usage time |
| `claude_code_lines_of_code_count_total` | Counter | Lines changed |
| `claude_code_code_edit_tool_decision_total` | Counter | Edit accepts/rejects |
| `claude_code_pull_request_count_total` | Counter | PRs created |
| `claude_code_commit_count_total` | Counter | Commits created |

### Token Types
- `input` - Tokens sent to the model
- `output` - Tokens generated by the model
- `cacheRead` - Tokens read from prompt cache
- `cacheCreation` - Tokens used to create cache

### Key Labels
| Label | Description |
|-------|-------------|
| `model` | Model identifier |
| `session_id` | Unique session ID |
| `user_email` | User's email (required for per-user metrics) |
| `terminal_type` | Terminal/IDE (iTerm.app, vscode, cursor) |

## Key Metrics (Communication Quality)

Three metrics that tell you how well you're communicating with Claude:

| Metric | Formula | Target | What It Means |
|--------|---------|--------|---------------|
| **Cache Ratio** | cacheRead / cacheCreate | >20:1 | Your CLAUDE.md is working |
| **Session Size** | tokens / sessions | <100k | You're being efficient |
| **Accept Rate** | accepts / total | 75-85% | You're engaged, not rubber-stamping |

### What to Improve

| Symptom | Meaning | Action |
|---------|---------|--------|
| Low cache ratio (<10:1) | Claude rebuilds context constantly | Improve your CLAUDE.md |
| Large sessions (>300k) | Going in circles or unclear prompts | Fresh sessions, clearer goals |
| High accept rate (>95%) | Not reviewing critically | Slow down, read the diffs |
| Low accept rate (<60%) | Claude misunderstands you | Add examples and patterns |

See [GUIDE.md](GUIDE.md) for the full Architect philosophy.

## Generate Communication Quality Report

Check your three key metrics (Cache Ratio, Session Size, Accept Rate):

```bash
# Last 7 days (default)
./scripts/generate-report.sh

# Last 30 days
RANGE=30d ./scripts/generate-report.sh

# Save to file
./scripts/generate-report.sh > report.md
```

Quick health check (stack status + key metrics):
```bash
./scripts/health-check.sh
```

## Storage & Retention

| Component | Time Limit | Size Limit | Notes |
|-----------|------------|------------|-------|
| Prometheus | 30 days | 1 GB | Whichever hits first |
| Loki | 30 days | Ingestion throttled | Tool usage logs |
| Grafana | Unlimited | ~5 MB | Config only |

Check storage usage:
```bash
./scripts/check-storage.sh
```

Emergency cleanup:
```bash
podman compose down
rm -rf data/prometheus/* data/loki/*
podman compose up -d
```

## Custom Labels (Bedrock Users)

Anthropic subscription users get `user_email` automatically. **Bedrock users MUST set it manually:**

```bash
USER_EMAIL=$(git config --global user.email)
export OTEL_RESOURCE_ATTRIBUTES="user_email=$USER_EMAIL,provider=bedrock,team=platform"
```

## Common Tasks

```bash
# Check if metrics are flowing
podman logs claude-otel-collector 2>&1 | grep -E "(Metrics|Logs)Exporter"

# Query Prometheus directly
curl -s 'http://localhost:9090/api/v1/query?query=sum(claude_code_cost_usage_USD_total)' | jq '.data.result[0].value[1]'

# Restart after config changes
podman compose restart grafana
podman compose restart otel-collector

# Full restart
podman compose down && podman compose up -d
```

## Troubleshooting

### No data in Grafana
1. Verify telemetry is enabled: `echo $CLAUDE_CODE_ENABLE_TELEMETRY`
2. Check OTEL collector: `podman logs claude-otel-collector`
3. Check Prometheus targets: http://localhost:9090/targets

### Dashboard looks wrong
```bash
podman compose restart grafana
```

## References

- [Claude Code Monitoring Docs](https://docs.anthropic.com/en/docs/claude-code/monitoring)
- [Anthropic ROI Guide](https://github.com/anthropics/claude-code-monitoring-guide)
- [OpenTelemetry Spec](https://opentelemetry.io/docs/specs/otel/)
