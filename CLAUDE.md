# Claude Code Metrics

Local observability stack for tracking Claude Code usage, cost, and ROI via OpenTelemetry.

**Philosophy:** This is about growth, not surveillance. See [HUMAN-AI-COLLABORATION.md](HUMAN-AI-COLLABORATION.md) for the co-intelligence framework.

## Quick Start

```bash
# Start (use podman or docker)
podman compose up -d

# Access
open http://localhost:3000  # Grafana (admin / claudecode)
open http://localhost:9090  # Prometheus
```

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐     ┌─────────────┐
│   Claude Code   │────▶│  OTEL Collector  │────▶│  Prometheus │────▶│   Grafana   │
│  (your terminal)│     │   :4317/:4318    │     │    :9090    │     │    :3000    │
└─────────────────┘     └────────┬─────────┘     └─────────────┘     └─────────────┘
                                 │
                                 ▼
                          ┌─────────────┐
                          │    Loki     │  (logs for tool usage)
                          │    :3100    │
                          └─────────────┘
```

## File Structure

```
claude-metrics/
├── docker-compose.yaml          # Container orchestration
├── otel-config.yaml             # OTEL Collector pipeline (metrics + logs)
├── prometheus.yaml              # Prometheus scrape config
├── loki-config.yaml             # Loki log storage config
├── grafana/
│   ├── dashboards/
│   │   ├── claude-code.json     # Personal dashboard
│   │   └── team-overview.json   # Team dashboard
│   └── provisioning/            # Auto-provisioning
├── scripts/
│   ├── setup-mac.sh             # Mac onboarding (interactive)
│   ├── generate-report.sh       # CLI ROI report generator
│   ├── check-storage.sh         # Storage usage monitor
│   └── health-check.sh          # Quick metrics health check
├── TESTING.md                   # Testing guide and patterns
├── data/                        # Persistent storage (git-ignored)
│   ├── prometheus/              # Metrics TSDB
│   ├── loki/                    # Log storage
│   └── grafana/                 # Grafana DB
├── CLAUDE.md                    # This file
└── HUMAN-AI-COLLABORATION.md    # Co-intelligence philosophy
```

## Enabling Telemetry

Set these environment variables before running Claude Code:

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_LOGS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

Or use the interactive setup:
```bash
./scripts/setup-mac.sh
```

Or use [claude-switch](https://github.com/your-org/claude-switcher) which configures telemetry automatically.

## Dashboards

### Personal Dashboard (claude-code)
- **Overview:** Cost, tokens, sessions, lines of code
- **Efficiency:** Accept Rate, Cache Ratio, Session Size gauges
- **Breakdown:** By model, by token type, by terminal
- **Tool Usage:** From Loki logs - see which tools you use most

### Team Dashboard (team-overview)
- **Organization Overview:** Total cost, active users, PRs, commits
- **ROI Metrics:** Cost/PR, Cost/Session, Cost/Commit, Sessions/PR
- **Developer Leaderboard:** Per-user metrics table
- **Tool Usage:** Team-wide tool distribution
- **Productivity:** Lines added/removed, active time, cost/hour

## Available Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `claude_code_cost_usage_USD_total` | Counter | Cumulative cost in USD |
| `claude_code_token_usage_tokens_total` | Counter | Token counts by type |
| `claude_code_session_count_total` | Counter | Session starts |
| `claude_code_active_time_seconds_total` | Counter | Active usage time |
| `claude_code_lines_of_code_count_total` | Counter | Lines changed |
| `claude_code_code_edit_tool_decision_total` | Counter | Edit accepts/rejects |
| `claude_code_pull_request_count_total` | Counter | PRs created |
| `claude_code_commit_count_total` | Counter | Commits created |

### Token Types
- `input` - Tokens sent to the model
- `output` - Tokens generated by the model
- `cacheRead` - Tokens read from prompt cache
- `cacheCreation` - Tokens used to create cache

### Key Labels
| Label | Description |
|-------|-------------|
| `model` | Model identifier |
| `session_id` | Unique session ID |
| `user_email` | User's email (required for per-user metrics) |
| `terminal_type` | Terminal/IDE (iTerm.app, vscode, cursor) |

## Key Metrics & Benchmarks

| Metric | Formula | Good | Warning | Concern |
|--------|---------|------|---------|---------|
| **Accept Rate** | accepts / total | 75-85% | 60-75% or 85-95% | <60% or >95% |
| **Cache Ratio** | reads / creates | >20:1 | 10-20:1 | <10:1 |
| **Session Size** | tokens / sessions | <100k | 100-300k | >300k |
| **Cost/PR** | cost / prs | <$5 | $5-10 | >$10 |
| **Cost/Session** | cost / sessions | <$0.10 | $0.10-0.50 | >$0.50 |

### What These Mean (Growth Mindset)

| Metric | What It Tells You |
|--------|-------------------|
| **Accept Rate** | Your critical engagement with AI suggestions |
| **Cache Ratio** | How well your documentation communicates context |
| **Session Size** | Whether you're working efficiently or going in circles |
| **Cost/PR** | Value delivered per dollar spent |

See [HUMAN-AI-COLLABORATION.md](HUMAN-AI-COLLABORATION.md) for the philosophy behind these metrics.

## Generate ROI Report

```bash
# Last 7 days (default)
./scripts/generate-report.sh

# Last 30 days
RANGE=30d ./scripts/generate-report.sh

# Save to file
./scripts/generate-report.sh > report.md
```

## Storage & Retention

| Component | Time Limit | Size Limit | Notes |
|-----------|------------|------------|-------|
| Prometheus | 30 days | 1 GB | Whichever hits first |
| Loki | 30 days | Ingestion throttled | Tool usage logs |
| Grafana | Unlimited | ~5 MB | Config only |

Check storage usage:
```bash
./scripts/check-storage.sh
```

Emergency cleanup:
```bash
podman compose down
rm -rf data/prometheus/* data/loki/*
podman compose up -d
```

## Custom Labels (Bedrock Users)

Anthropic subscription users get `user_email` automatically. **Bedrock users MUST set it manually:**

```bash
USER_EMAIL=$(git config --global user.email)
export OTEL_RESOURCE_ATTRIBUTES="user_email=$USER_EMAIL,provider=bedrock,team=platform"
```

## Common Tasks

```bash
# Check if metrics are flowing
podman logs claude-otel-collector 2>&1 | grep -E "(Metrics|Logs)Exporter"

# Query Prometheus directly
curl -s 'http://localhost:9090/api/v1/query?query=sum(claude_code_cost_usage_USD_total)' | jq '.data.result[0].value[1]'

# Restart after config changes
podman compose restart grafana
podman compose restart otel-collector

# Full restart
podman compose down && podman compose up -d
```

## Troubleshooting

### No data in Grafana
1. Verify telemetry is enabled: `echo $CLAUDE_CODE_ENABLE_TELEMETRY`
2. Check OTEL collector: `podman logs claude-otel-collector`
3. Check Prometheus targets: http://localhost:9090/targets

### Dashboard looks wrong
```bash
podman compose restart grafana
```

## References

- [Claude Code Monitoring Docs](https://docs.anthropic.com/en/docs/claude-code/monitoring)
- [Anthropic ROI Guide](https://github.com/anthropics/claude-code-monitoring-guide)
- [OpenTelemetry Spec](https://opentelemetry.io/docs/specs/otel/)
